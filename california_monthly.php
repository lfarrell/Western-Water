<?php
//http://cdec.water.ca.gov/misc/monthly_res.html
date_default_timezone_set('America/Los_Angeles');
include 'simple_html_dom.php';

$reservoirs = array(
"KLM",
"GBR",
"IRG",
"CLK",
"DWN",
"CLE",
"LEW",
"RTD",
"PLL",
"MNC",
"WRS",
"SLJ",
"NCA",
"KNT",
"BMP",
"LGT",
"APN",
"HNN",
"BIO",
"USL",
"CHB",
"DLV",
"SAT",
"CVE",
"AST",
"LNG",
"LRA",
"CYC",
"CRY",
"SPB",
"LFY",
"SNN",
"ATN",
"WHR",
"SLN",
"NCM",
"JNN",
"TWT",
"CCH",
"GBL",
"MAT",
"CSI",
"PYM",
"BQC",
"CAS",
"PRU",
"CGS",
"SGB",
"MHW",
"PRR",
"HMT",
"BRV",
"SVO",
"VLP",
"SGC",
"RLC",
"DMV",
"VIL",
"STD",
"HDG",
"SKN",
"HNS",
"CUY",
"SVT",
"MMR",
"ELC",
"MRR",
"MOR",
"BRT",
"LVD",
"LOT",
"SHA",
"KES",
"WHI",
"MCO",
"IRC",
"BIT",
"BLB",
"STG",
"EPK",
"MMW",
"ALM",
"BTV",
"ANT",
"BCL",
"DAV",
"FRD",
"LGV",
"SLC",
"ORO",
"THD",
"TFR",
"TMT",
"TAB",
"JCK",
"BWN",
"BWS",
"FRL",
"BUL",
"SPG",
"SFL",
"ENG",
"RLL",
"CFW",
"CMB",
"LVY",
"FMD",
"HHL",
"LON",
"EDN",
"UNV",
"ICH",
"SLB",
"CPL",
"FOL",
"SIV",
"NAT",
"INV",
"CLA",
"BER",
"SOL",
"BTH",
"LVQ",
"JNK",
"LWB",
"SLS",
"PAR",
"CMN",
"NHG",
"SPM",
"DON",
"RLF",
"BRD",
"SWB",
"LYS",
"NML",
"TUL",
"CHY",
"ENR",
"HTH",
"DNP",
"MDO",
"TLC",
"MCR",
"MCS",
"BUC",
"HID",
"TAE",
"MPL",
"CNV",
"FLR",
"HNT",
"SHV",
"RDN",
"KRH",
"MIL",
"SNL",
"ONF",
"LUS",
"SLF",
"LSB",
"CTG",
"WSN",
"PNF",
"TRM",
"SCC",
"ISB",
"STP",
"INL",
"BOC",
"PRS",
"MRT",
"DNL",
"TAH",
"BDP",
"SDB",
"GNT",
"GLK",
"CRW",
"SLK",
"TNM",
"HWE",
"QUL",
"SLW"
);

$day = date('d-M-Y+H:i');

foreach($reservoirs as $key => $reservoir) {
    $full_link = "http://cdec.water.ca.gov/cgi-progs/queryMonthly?$reservoir&d=$day&span=50years";
    $html = new simple_html_dom();
    $html->load_file($full_link);

    $res_name = $html->find('h1');
    $name = ucwords(strtolower(preg_replace('/\(.+$/', '', trim($res_name[0]->plaintext))));
    $file_name = preg_replace('/\s+/', '_', strtolower($name));

    $fh = fopen("$file_name.csv", "wb");
    fputcsv($fh, array("reservoir", "storage", "capacity", "pct_capacity", "date"));

    $rows = $html->find('tr');
    foreach($rows as $row) {
        $date = $row->find('td',0);
        $d = $date->plaintext;

        $volume = $row->find('td',2);
        $vol = trim($volume->plaintext);

        $regx = '/^\d/';
        if(preg_match($regx, $d) && preg_match($regx, $vol)) {
            fputcsv($fh, array(trim($name), $vol, $d));
        }
    }
    fclose($fh);
exit;
}