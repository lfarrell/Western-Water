angular.module("westernWaterApp").directive("mapGraph",["tipService","StatsService","chartService",function(t,p,h){return{restrict:"C",link:function(q,G,C){var a={top:20,right:130,left:100,bottom:80},u=600-a.top-a.bottom,v=900-a.left-a.right,l=550-a.left-a.right,c=500-a.top-a.bottom,f=d3.time.format("%m/%Y").parse,H=t.tipDiv();q.$watchGroup(["map","stations","data"],function(b){function z(){r.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")");2<d3.event.scale&&d3.selectAll("#map circle").attr("r",
    1.5)}function N(a){m.domain([d3.min(a,function(a){return f(a.date)}),d3.max(a,function(a){return f(h.graphPadding())})]);A.domain([1.2*d3.max(a,function(a){return a.capacity}),0]);d3.select("g.x").transition().duration(1E3).ease("sin-in-out").call(D);d3.select("g.y").transition().duration(1E3).ease("sin-in-out").call(E);d3.select("#storage").transition().duration(1E3).ease("sin-in-out").attr("d",x(a));d3.select("#avg_storage").transition().duration(1200).ease("sin-in-out").attr("d",q(a));d3.select("#capacity").transition().duration(1E3).ease("sin-in-out").attr("d",
    I(a));var b=a[0];d3.select("#reservoir").text(b.reservoir+", "+b.state);d3.selectAll("#all_res_avg").text(p.numFormat(a[0].mean.toFixed(1)))}function d(a){d3.event.sourceEvent.stopPropagation();d3.select(this).attr("x",a.x=d3.event.x).attr("y",a.y=d3.event.y)}function J(){var n=m.invert(d3.mouse(this)[0]),b=F(datz,n,1),e=datz[b-1],b=datz[b];void 0===b&&(b=Infinity);n=n-e.date>b.date-n?b:e;e="translate("+(m(f(n.date))+a.left)+","+(A(n.storage)+a.top)+")";d3.select("#graph circle.y0").attr("transform",
    e);d3.select("#graph text.y0").attr("transform",e).tspans(["Date: "+n.date,"Vol: "+p.numFormat(n.storage)+" acre ft","Pct Full: "+n.pct_capacity+"%","Pct of Hist. Avg: "+(n.storage/n.mean*100).toFixed(1)+"%"]);e="translate("+(m(f(n.date))+a.left)+","+(A(n.capacity)+a.top)+")";d3.select("#graph circle.y1").attr("transform",e);d3.select("#graph text.y1").attr("transform",e).tspans(["Date: "+n.date,"Capacity: "+p.numFormat(n.capacity)+" acre ft"],-15)}if(b[0]&&b[1]&&b[2]){var g=b[0],e=b[1],w=b[2],y=
    d3.geo.albers().rotate([96,0]).center([-.6,38.7]).parallels([29.5,45.5]).scale(925).translate([v/2,u/2]).precision(.1);b=d3.geo.path().projection(y);var k=w.filter(function(a){return"Shasta Dam"===a.reservoir});datz=h.histAvg(k,"map-graph");k=d3.behavior.zoom().scaleExtent([1,10]).on("zoom",z);d3.behavior.drag().origin(function(a){return a}).on("drag",d);var r=d3.select("#map").append("svg").attr("height",u).attr("width",v).call(k).append("g");r.selectAll("path").data(g.features).enter().append("path").attr("d",
    b);r.selectAll("circle").data(e).enter().append("circle").attr("class","map-circle").attr("cx",function(a){return y([a.lng,a.lat])[0]}).attr("cy",function(a){return y([a.lng,a.lat])[1]}).attr("r",function(a){return 2.4}).on("click",function(a){var m=w.filter(function(m){return m.reservoir===a.reservoir});datz=h.histAvg(m,"map-graph");N(datz)}).on("mouseover",function(a){t.tipShow(H,a.reservoir)}).on("mouseout",function(a){t.tipHide(H)});var m=d3.time.scale().range([0,l]);m.domain([d3.min(datz,function(a){return f(a.date)}),
    d3.max(datz,function(a){return f(h.graphPadding())})]);var A=d3.scale.linear().domain([1.2*d3.max(datz,function(a){return a.capacity}),0]).range([0,c]),F=d3.bisector(function(a){return f(a.date)}).right,D=d3.svg.axis().scale(m).orient("bottom"),E=d3.svg.axis().scale(A).orient("left");h.legend("#res_legend");d3.selectAll("#all_res_avg").text(p.numFormat(datz[0].mean.toFixed(1)));g=h.chart("#graph",c,l,a,D,E,"Acre Feet");d3.selectAll("g.x text").attr("transform","rotate(35)").attr("dx",27).attr("dy",
    10);var x=d3.svg.line().x(function(a){return m(f(a.date))}).y(function(a){return A(a.storage)});g.append("path").attr("d",x(datz)).attr("id","storage").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).attr("transform","translate("+a.left+","+a.top+")");var B=h.focus(g);g.append("rect").attr("class","overlay").attr("width",l).attr("height",c).on("mouseover",function(){B.style("display",null)}).on("mouseout",function(){B.style("display","none")}).on("mousemove",J).attr("transform",
    "translate("+a.left+","+a.top+")");var q=d3.svg.line().x(function(a){return m(f(a.date))}).y(function(a){return A(a.mean)});g.append("g").append("path").attr("d",q(datz)).attr("id","avg_storage").attr("fill","none").attr("stroke","#FCE883").attr("stroke-width",2).attr("stroke-dasharray",[5,5]).attr("transform","translate("+a.left+","+a.top+")");var I=d3.svg.line().x(function(a){return m(f(a.date))}).y(function(a){return A(a.capacity)});g.append("g").append("path").attr("d",I(datz)).attr("id","capacity").attr("fill",
    "none").attr("stroke","green").attr("stroke-width",2).attr("transform","translate("+a.left+","+a.top+")")}})},scope:{map:"=",data:"=",stations:"="}}}]);
angular.module("westernWaterApp").directive("totalsCharts",["tipService","StatsService","chartService",function(t,p,h){return{restrict:"C",link:function(t,G,C){var a={top:20,right:130,left:100,bottom:80},u=600-a.left-a.right,v=550-a.top-a.bottom,l=d3.time.format("%m/%Y").parse;h.legend("#compare_legend",!0);t.$watchGroup(["data","state"],function(c){function f(c){var d=t.filter(function(a){return a.state===b}),d=crossfilter(d).dimension(function(a){return a.date}),f=d.group().reduceSum(function(a){return a.capacity}).top(Infinity).sort(function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       b){var e=a.key.split("/"),c=b.key.split("/"),e=new Date(e[1],e[0]-1),c=new Date(c[1],c[0]-1);return e<c?-1:e>c?1:0}),g=d.group().reduceSum(function(a){return a.storage}).top(Infinity).sort(function(a,b){var e=a.key.split("/"),c=b.key.split("/"),e=new Date(e[1],e[0]-1),c=new Date(c[1],c[0]-1);return e<c?-1:e>c?1:0});g.forEach(function(a){a.cap=_.find(f,function(e){return a.key===e.key}).value});g=h.histAvg(g);d=g.filter(function(a){return a.key===z});d=d3.sum(_.pluck(d,"value"));d=Math.round(d/f[f.length-
    1].value*100).toFixed(1);d3.select(c+" span").html("("+d+"% of full capacity)");var e=d3.bisector(function(a){return l(a.key)}).right,w=d3.time.scale().domain([l(d3.min(g,function(a){return a.key})),l(d3.max(g,function(a){return h.graphPadding()}))]).range([0,u]),y=d3.scale.linear().domain([d3.max(f,function(a){return a.value})+25E5,0]).range([0,v]),d=d3.svg.axis().scale(w).orient("bottom"),k=d3.svg.axis().scale(y).orient("left"),d=h.chart(c,v,u,a,d,k,"Acre Feet"),k=d3.svg.line().x(function(a){return w(l(a.key))}).y(function(a){return y(a.value)});
    d.append("g").append("path").attr("d",k(g)).attr("class","storage").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).attr("transform","translate("+a.left+","+a.top+")");k=d3.svg.line().x(function(a){return w(l(a.key))}).y(function(a){return y(a.mean)});d.append("g").append("path").attr("d",k(g)).attr("id","avg_storage").attr("fill","none").attr("stroke","#FCE883").attr("stroke-width",2).attr("stroke-dasharray",[5,5]).attr("transform","translate("+a.left+","+a.top+")");d3.selectAll(c+
        "_avg").text(p.numFormat(g[0].mean.toFixed(1)));var r=h.focus(d);d.append("rect").attr("class","overlay").attr("width",u).attr("height",v).on("mouseover",function(){r.style("display",null)}).on("mouseout",function(){r.style("display","none")}).on("mousemove",function(){var b=w.invert(d3.mouse(this)[0]),d=e(g,b,1),h=g[d-1],d=g[d];void 0===d&&(d=Infinity);var k=b-h.key>d.key-b?d:h,b=_.filter(f,function(a){return a.key===k.key}),h="translate("+(w(l(k.key))+a.left)+","+(y(k.value)+a.top)+")";d3.select(c+
        " circle.y0").attr("transform",h);d3.select(c+" text.y0").attr("transform",h).tspans(["Date: "+k.key,"Vol: "+p.numFormat(k.value)+" acre ft","Pct Full: "+(k.value/b[0].value*100).toFixed(1)+"%","Pct of Hist. Avg: "+(k.value/g[0].mean*100).toFixed(1)+"%"]);b="translate("+(w(l(k.key))+a.left)+","+(y(k.cap)+a.top)+")";d3.select(c+" circle.y1").attr("transform",b);d3.select(c+" text.y1").attr("transform",b).tspans(["Date: "+k.key,"Vol: "+p.numFormat(k.cap)+" acre ft"],-15)}).attr("transform","translate("+
            a.left+","+a.top+")");k=d3.svg.line().x(function(a){return w(l(a.key))}).y(function(a){return y(a.value)});d.append("g").append("path").attr("d",k(f)).attr("class","capacity").attr("transform","translate("+a.left+","+a.top+")")}if(c[0]){var t=c[0],b=c[1];c=moment().subtract(1,"month");var z=c.format("MM/YYYY");c=c.format("MMMM YYYY");d3.select("#date").html("(for Month Ending "+c+")");"CA"===b?f("#ca_capacities"):f("#tx_capacities")}})},scope:{data:"=",state:"@"}}}]);
angular.module("westernWaterApp").directive("stateGraph",["tipService","StatsService","chartService",function(t,p,h){return{restrict:"C",link:function(q,G,C){var a={top:20,right:130,left:100,bottom:80},u=675-a.top-a.bottom,v=900-a.left-a.right,l=550-a.left-a.right,c=500-a.top-a.bottom,f=d3.time.format("%m/%Y").parse,H=t.tipDiv();q.$watchGroup(["map","stations","data","res","state"],function(b){function z(){E.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")");2<d3.event.scale&&
d3.selectAll("#map circle").attr("r",5)}function q(a){d3.event.sourceEvent.stopPropagation();d3.select(this).attr("x",a.x=d3.event.x).attr("y",a.y=d3.event.y)}function d(a){x.domain([d3.min(a,function(a){return f(a.date)}),d3.max(a,function(a){return f(h.graphPadding())})]);B.domain([1.2*d3.max(a,function(a){return a.capacity}),0]);d3.select("g.x").transition().duration(1E3).ease("sin-in-out").call(I);d3.select("g.y").transition().duration(1E3).ease("sin-in-out").call(n);d3.select("#storage").transition().duration(1E3).ease("sin-in-out").attr("d",
    C(a));d3.select("#avg_storage").transition().duration(1E3).ease("sin-in-out").attr("d",K(a));d3.select("#capacity").transition().duration(1E3).ease("sin-in-out").attr("d",L(a));var b=a[0];d3.select("#reservoir").text(b.reservoir);d3.selectAll("#res_avg").text(p.numFormat(a[0].mean.toFixed(1)))}function J(){var b=x.invert(d3.mouse(this)[0]),e=G(state_data,b,1),c=state_data[e-1],e=state_data[e];void 0===e&&(e=Infinity);b=b-c.date>e.date-b?e:c;c="translate("+(x(f(b.date))+a.left)+","+(B(b.storage)+a.top)+
    ")";d3.select("circle.y0").attr("transform",c);d3.select("text.y0").attr("transform",c).tspans(["Date: "+b.date,"Vol: "+p.numFormat(b.storage)+" acre ft","Pct Full: "+b.pct_capacity+"%","Pct of Hist. Avg: "+(b.storage/state_data[0].mean*100).toFixed(1)+"%"]);c="translate("+(x(f(b.date))+a.left)+","+(B(b.capacity)+a.top)+")";d3.select("#graph circle.y1").attr("transform",c);d3.select("#graph text.y1").attr("transform",c).tspans(["Date: "+b.date,"Capacity: "+p.numFormat(b.capacity)+" acre ft"],-15)}
    if(b[0]&&b[1]&&b[2]&&b[3]&&b[4]){var g=b[0],e=b[1],w=b[2],y=b[3],k=b[4];b=w.filter(function(a){return a.reservoir===y});state_data=h.histAvg(b,"map-graph");var r=1,m=d3.geo.mercator().scale(r).translate([v/2,u/2]),A=d3.geo.centroid(g);b=d3.geo.path().projection(m);var F=b.bounds(g),D=r*v/(F[1][0]-F[0][0]),r=r*u/(F[1][1]-F[0][1]),r=D<r?D:r,D="utah"===k||"ca"===k?288:250,m=d3.geo.mercator().center(A).scale(r/1.15).translate([350,D]);b=b.projection(m);A=d3.behavior.zoom().scaleExtent([1,5]).on("zoom",
        z);d3.behavior.drag().origin(function(a){return a}).on("drag",q);var E=d3.select("#map").append("svg").attr("height",u).attr("width",v).call(A).append("g");E.selectAll("path").data(g.features).enter().append("path").attr("d",b);E.selectAll("circle").data(e).enter().append("circle").attr("class","map-circle").attr("cx",function(a){return m([a.lng,a.lat])[0]}).attr("cy",function(a){return m([a.lng,a.lat])[1]}).attr("r",function(a){return"ca"===k?3.5:5}).on("click",function(a){var b=w.filter(function(b){return b.reservoir===
        a.reservoir});state_data=h.histAvg(b,"map-graph");d(state_data)}).on("mouseover",function(a){t.tipShow(H,a.reservoir)}).on("mouseout",function(a){t.tipHide(H)});var x=d3.time.scale().range([0,l]);x.domain([d3.min(state_data,function(a){return f(a.date)}),d3.max(state_data,function(a){return f(h.graphPadding())})]);var B=d3.scale.linear().domain([1.2*d3.max(state_data,function(a){return a.capacity}),0]).range([0,c]),G=d3.bisector(function(a){return f(a.date)}).right,I=d3.svg.axis().scale(x).orient("bottom"),
        n=d3.svg.axis().scale(B).orient("left");h.legend("#res_legend");g=h.chart("#graph",c,l,a,I,n,"Acre Feet");d3.selectAll("g.x text").attr("transform","rotate(35)").attr("dx",27).attr("dy",10);d3.selectAll("#res_avg").text(p.numFormat(state_data[0].mean.toFixed(1)));var C=d3.svg.line().x(function(a){return x(f(a.date))}).y(function(a){return B(a.storage)});g.append("path").attr("d",C(state_data)).attr("id","storage").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).attr("transform",
        "translate("+a.left+","+a.top+")");var K=d3.svg.line().x(function(a){return x(f(a.date))}).y(function(a){return B(a.mean)});g.append("g").append("path").attr("d",K(state_data)).attr("id","avg_storage").attr("fill","none").attr("stroke","#FCE883").attr("stroke-width",2).attr("stroke-dasharray",[5,5]).attr("transform","translate("+a.left+","+a.top+")");var L=d3.svg.line().x(function(a){return x(f(a.date))}).y(function(a){return B(a.capacity)});g.append("g").append("path").attr("d",L(state_data)).attr("id",
        "capacity").attr("fill","none").attr("stroke","green").attr("stroke-width",2).attr("transform","translate("+a.left+","+a.top+")");var M=h.focus(g);g.append("rect").attr("class","overlay").attr("width",l).attr("height",c).on("mouseover",function(){M.style("display",null)}).on("mouseout",function(){M.style("display","none")}).on("mousemove",J).attr("transform","translate("+a.left+","+a.top+")")}})},scope:{map:"=",data:"=",stations:"=",res:"@",state:"@"}}}]);
angular.module("westernWaterApp").directive("snowCharts",["StatsService","chartService","tipService",function(t,p,h){return{restrict:"C",link:function(q,G,C){var a={top:20,right:150,left:100,bottom:80},u=1250-a.left-a.right,v=500-a.top-a.bottom,l=d3.time.format("%m/%Y").parse;h.tipDiv();q.$watchGroup(["snowdata","state"],function(c){function f(){var e=z.invert(d3.mouse(this)[0]),c=g(b,e,1),d=b[c-1],c=b[c];void 0===c&&(c=Infinity);e=e-d.key>c.key-e?c:d;d="translate("+(z(l(e.key))+a.left)+","+(q(e.value)+
    a.top)+")";d3.select("#snow_level circle.y0").attr("transform",d);d3.select("#snow_level text.y0").attr("transform",d).tspans(["Date: "+e.key,"Snow Water Eqv: "+e.value.toFixed(1)+" inches","Pct of Hist. Avg: "+(e.value/b[0].mean*100).toFixed(1)+"%"])}if(c[0]){c=c[0];var h=d3.nest().key(function(a){return a.date}).rollup(function(a){return d3.mean(a,function(a){return+a.snow_water_equivalent})}).map(c),b=[];_.keys(h).forEach(function(a){b.push({key:a,value:h[a]})});b=p.histAvg(b);b.sort(function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         b){var c=a.key.split("/"),d=b.key.split("/"),c=new Date(c[1],c[0]-1),d=new Date(d[1],d[0]-1);return c<d?-1:c>d?1:0});var z=d3.time.scale().domain([d3.min(b,function(a){return l(a.key)}),d3.max(b,function(a){return l(a.key)})]).range([0,u]),q=d3.scale.linear().domain([d3.max(b,function(a){return a.value}),0]).range([0,v]);c=d3.svg.axis().scale(z).orient("bottom");var d=d3.svg.axis().scale(q).orient("left");c=p.chart("#snow_level",v,u,a,c,d,"Snow Water Equivalent (inches)");d3.selectAll("#snow_avg").text(t.numFormat(b[0].mean.toFixed(1)));d=d3.svg.line().x(function(a){return z(l(a.key))}).y(function(a){return q(a.value)});c.append("g").append("path").attr("d",d(b)).attr("class","snow").attr("transform","translate("+a.left+","+a.top+")");d=d3.svg.line().x(function(a){return z(l(a.key))}).y(function(a){return q(a.mean)});c.append("g").append("path").attr("d",d(b)).attr("class","snow_avg").attr("transform","translate("+a.left+","+a.top+")").style("stroke-dasharray","5,5");var C=p.focus(c,!0);c.append("rect").attr("class","overlay").attr("width",u).attr("height",v).on("mouseover",function(){C.style("display",null)}).on("mouseout",function(){C.style("display","none")}).on("mousemove",f).attr("transform","translate("+a.left+","+a.top+")");var g=d3.bisector(function(a){return l(a.key)}).right}})},scope:{snowdata:"=",state:"@"}}}]);